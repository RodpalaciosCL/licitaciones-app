<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Subir y Analizar Licitaci칩n</title>
</head>
<body>
  <h1>Prueba de Subida y An치lisis de Licitaci칩n</h1>

  <input type="file" id="fileInput" />
  <button type="button" onclick="uploadFile()">Subir y Procesar</button>
  <button type="button" onclick="analizarLicitacion()">Analizar Licitaci칩n (GPT)</button>

  <div id="result"></div>

  <script>
    let lastFileId = null;

    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Selecciona un archivo.");

      const base64 = await fileToBase64(file);

      const resp = await fetch('/.netlify/functions/uploadToDrive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: file.name,
          fileContent: base64
        })
      });

      const data = await resp.json();
      console.log('[uploadFile] Respuesta:', data);

      if (data.success) {
        lastFileId = data.fileId;
        document.getElementById('result').innerText = `Archivo subido con ID: ${data.fileId}`;
      } else {
        document.getElementById('result').innerText = `Error al subir: ${data.error}`;
        console.error('Stack:', data.stack);
      }
    }

    async function analizarLicitacion() {
      if (!lastFileId) return alert("Primero sube un archivo.");

      const resp = await fetch('/.netlify/functions/processDoc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId: lastFileId })
      });

      const result = await resp.json();
      console.log('[analizarLicitacion] Respuesta:', result);

      if (result.success) {
        document.getElementById('result').innerText =
          `GPT: ${result.rawGPT}\n` +
          `bufferLength: ${result.bufferLength}\n` +
          `textLength: ${result.textLength}`;
      } else {
        document.getElementById('result').innerText = `Error al procesar: ${result.error}`;
        console.error('Stack:', result.stack);
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
