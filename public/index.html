<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Prueba de Subida a Drive</title>
  </head>
  <body>
    <h1>Prueba de Subida a Drive</h1>

    <!-- Importante: NO usar <form>. Evitamos submit. -->
    <input type="file" id="fileInput" />
    <!-- El botón con type="button" para que no haga un form-submit -->
    <button type="button" onclick="uploadFile()">Subir y Procesar</button>

    <div id="result"></div>

    <script>
      async function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) {
          alert("Por favor, selecciona un archivo primero.");
          return;
        }

        // Convertir el archivo a base64
        const base64 = await fileToBase64(file);

        // Hacer el fetch con JSON
        const resp = await fetch('/.netlify/functions/uploadToDrive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            fileContent: base64
          })
        });

        // Manejar la respuesta
        const data = await resp.json();
        if (data.success) {
          document.getElementById('result').innerText =
            `Archivo subido con ID: ${data.fileId}\n` +
            `Link de vista: ${data.viewLink}`;
        } else {
          document.getElementById('result').innerText = `Error: ${data.error}`;
        }
      }

      // Función para leer el archivo y pasarlo a base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const dataUrl = reader.result;
            // "data:<mime>;base64,AAAA..."
            const base64 = dataUrl.split(',')[1];
            resolve(base64);
          };
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
</html>
