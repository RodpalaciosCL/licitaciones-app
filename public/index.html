<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Subir y Analizar Licitaci칩n</title>
  </head>
  <body>
    <h1>Prueba de Subida y An치lisis de Licitaci칩n</h1>

    <input type="file" id="fileInput" />
    <button type="button" onclick="uploadFile()">Subir y Procesar</button>
    <button type="button" onclick="analizarLicitacion()">Analizar Licitaci칩n (GPT)</button>

    <div id="result"></div>

    <script>
      let lastFileId = null;

      async function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) {
          alert("Por favor, selecciona un archivo.");
          return;
        }

        const base64 = await fileToBase64(file);

        // Llamar a la function uploadToDrive
        const resp = await fetch('/.netlify/functions/uploadToDrive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            fileContent: base64
          })
        });

        const data = await resp.json();
        if (data.success) {
          lastFileId = data.fileId; // Guardamos el fileId para usar luego
          document.getElementById('result').innerText = 
            `Archivo subido con ID: ${data.fileId}\n` +
            `Link: ${data.viewLink}`;
        } else {
          document.getElementById('result').innerText = `Error: ${data.error}`;
        }
      }

      async function analizarLicitacion() {
        if (!lastFileId) {
          alert('Primero sube un archivo.');
          return;
        }

        // Llamar a la function processDoc
        const resp = await fetch('/.netlify/functions/processDoc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileId: lastFileId })
        });

        const result = await resp.json();
        if (result.success) {
          document.getElementById('result').innerText = result.rawGPT;
        } else {
          document.getElementById('result').innerText = `Error: ${result.error}`;
        }
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
</html>
