<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Subir y Analizar Licitación</title>
</head>
<body>
  <h1>Prueba de Subida y Análisis de Licitación</h1>

  <input type="file" id="fileInput" />
  <button type="button" onclick="uploadFile()">Subir y Procesar</button>
  <button type="button" onclick="analizarLicitacion()">Analizar Licitación (GPT)</button>

  <div id="result"></div>

  <script>
    let lastFileId = null;

    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        alert("Por favor, selecciona un archivo.");
        return;
      }

      // 1. Convertir a Base64
      const base64 = await fileToBase64(file);

      // 2. Llamar a la function uploadToDrive
      const resp = await fetch('/.netlify/functions/uploadToDrive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: file.name,
          fileContent: base64
        })
      });

      const data = await resp.json();
      console.log('[uploadFile] Respuesta:', data);

      if (data.success) {
        lastFileId = data.fileId; // Guardamos el fileId para usarlo luego
        document.getElementById('result').innerText =
          `Archivo subido con ID: ${data.fileId}\n`;
          // Si quisieras reintroducir logs, podrías: + `Carpeta: ${data.logs?.usedFolderId}\n` ...
      } else {
        document.getElementById('result').innerText = `Error al subir: ${data.error}`;
        console.error('Stack trace:', data.stack);
      }
    }

    async function analizarLicitacion() {
      if (!lastFileId) {
        alert('Primero sube un archivo.');
        return;
      }

      // 3. Llamar a la function processDoc con el fileId
      const resp = await fetch('/.netlify/functions/processDoc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId: lastFileId })
      });

      const result = await resp.json();
      if (result.success) {
        document.getElementById('result').innerText = result.rawGPT;
      } else {
        document.getElementById('result').innerText = `Error al procesar: ${result.error}`;
        console.error('Stack trace:', result.stack);
      }
    }

    // Función auxiliar para convertir un File a base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // reader.result es algo como: "data:application/pdf;base64,JVBER..."
          // Partimos la coma y tomamos la parte base64
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
